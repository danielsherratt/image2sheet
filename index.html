<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Image2Sheet</title>

<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="logo.svg" />

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- html2canvas + jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
*, *::before, *::after { box-sizing: border-box; }

@page { size: var(--page-size); margin: var(--page-margin); }

:root{
  --accent:#2b6cb0;
  --bg:#f4f6f8;
  --border:#e0e0e0;
  --shadow:0 10px 22px rgba(0,0,0,.1);
  --shadow-hover:0 12px 26px rgba(0,0,0,.16);
  --page-size: A4 portrait;
  --page-margin: 15mm;
}

body{
  margin:0;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background: var(--bg);
  color:#111;
}

.main{
  max-width: 760px;
  margin: 80px auto;
  background: #fff;
  padding: 28px;
  border-radius: 14px;
  box-shadow: var(--shadow);
}

/* ---------- HEADER (clickable dropdown) ---------- */
.header{
  position: relative;
  display:flex;
  align-items:center;
  gap:10px;
  cursor:pointer;
  user-select:none;
}

.header img{
  width:36px;
  height:36px;
}

.header h1{
  margin:0;
  font-size:22px;
  font-weight:650;
}

.header .chev{
  margin-left:auto;
  color:#666;
}

/* ---------- MENU ---------- */
.menu{
  position:absolute;
  top:52px;
  left:0;
  min-width: 230px;
  background:#fff;
  border:1px solid var(--border);
  border-radius: 10px;
  box-shadow: var(--shadow);
  display:none;
  flex-direction:column;
  z-index:50;
  overflow:hidden;
}

.menu.show{ display:flex; }

.menu a{
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px 14px;
  color:#111;
  text-decoration:none;
  font-size:15px;
}

.menu a:hover{
  background:#f1f3f5;
}

.menu a .fa-solid, .menu a .fa-regular{
  width:18px;
  text-align:center;
  color:#333;
}

/* ---------- DROP ZONES ---------- */
.drop{
  width:100%;
  border:2px dashed var(--border);
  border-radius: 12px;
  padding: 28px 18px;
  text-align:center;
  cursor:pointer;
  margin: 18px 0;
  transition: border-color .2s ease, box-shadow .2s ease, transform .2s ease;
  background:#fff;
}

.drop .icon{
  font-size: 30px;
  color: var(--accent);
  margin-bottom: 8px;
}

.drop:hover{
  border-color: var(--accent);
  box-shadow: 0 0 0 4px rgba(43,108,176,.12);
  transform: translateY(-2px);
}

.drop small{
  display:block;
  color:#555;
  margin-top:6px;
}

/* ---------- CONTROLS ---------- */
.controls{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
  margin-top: 8px;
}

.control label{
  display:block;
  font-size: 13px;
  color:#444;
  margin: 0 0 6px;
}

.control select{
  width:100%;
  padding: 10px 12px;
  border-radius: 10px;
  border:1px solid var(--border);
  background:#fff;
  font-size: 15px;
}

/* ---------- BUTTONS ---------- */
.actions{
  margin-top: 22px;
  display:flex;
  gap:12px;
  align-items:center;
}

.btn{
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding: 10px 14px;
  border-radius: 10px;
  border:none;
  background: var(--accent);
  color:#fff;
  cursor:pointer;
  width:auto;              /* NOT full width */
  transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
  box-shadow: none;
  font-size: 15px;
}

.btn:hover{
  transform: translateY(-2px) scale(.98);
  box-shadow: var(--shadow-hover);
  filter: brightness(1.02);
}

.btn:active{
  transform: translateY(-1px) scale(.99);
  box-shadow: var(--shadow);
}

/* ---------- PROGRESS OVERLAY ---------- */
.progress-overlay{
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index: 1000;
}

.progress-box{
  width: 340px;
  background:#fff;
  border:1px solid var(--border);
  border-radius: 12px;
  box-shadow: var(--shadow);
  padding: 18px;
}

.progress-box strong{
  display:block;
  margin-bottom: 10px;
}

.progress-bar{
  height: 10px;
  background:#eee;
  border-radius: 999px;
  overflow:hidden;
}

.progress-fill{
  height:100%;
  width:0%;
  background: var(--accent);
  transition: width .25s ease;
}
</style>
</head>

<body>

<div class="main">

  <!-- HEADER -->
  <div class="header" id="toolHeader" aria-label="Tool menu" tabindex="0">
    <img src="logo.svg" alt="logo" />
    <h1>Image2Sheet</h1>
    <i class="fa-solid fa-chevron-down chev" aria-hidden="true"></i>

    <nav class="menu" id="menu" aria-label="Tools">
      <a href="image2sheet.html"><i class="fa-solid fa-layer-group"></i>Image2Sheet</a>
      <a href="image2scale.html"><i class="fa-solid fa-up-right-and-down-left-from-center"></i>Image2Scale</a>
      <a href="cards.html"><i class="fa-solid fa-clone"></i>Playing cards</a>
    </nav>
  </div>

  <!-- FRONT DROP -->
  <div class="drop" id="frontDrop">
    <div class="icon"><i class="fa-solid fa-cloud-arrow-up"></i></div>
    <strong>Drop images here</strong>
    <small>or click to choose files</small>
    <input type="file" id="frontInput" hidden multiple accept="image/*" />
  </div>

  <!-- BACKING DROP -->
  <div class="drop" id="backDrop">
    <div class="icon"><i class="fa-regular fa-image"></i></div>
    <strong>Optional backing image</strong>
    <small>added as every second page</small>
    <input type="file" id="backInput" hidden accept="image/*" />
  </div>

  <!-- CONTROLS -->
  <div class="controls">
    <div class="control">
      <label for="paper">Paper</label>
      <select id="paper">
        <option value="a4" selected>A4</option>
        <option value="a3">A3</option>
      </select>
    </div>

    <div class="control">
      <label for="quantity">Quantity</label>
      <select id="quantity">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="4" selected>4</option>
        <option value="6">6</option>
        <option value="9">9</option>
      </select>
    </div>

    <div class="control">
      <label for="layout">Layout</label>
      <select id="layout">
        <option value="gap" selected>Gap</option>
        <option value="fill">Fill</option>
      </select>
    </div>

    <div class="control">
      <label for="orientation">Orientation</label>
      <select id="orientation">
        <option value="portrait" selected>Portrait</option>
        <option value="landscape">Landscape</option>
      </select>
    </div>
  </div>

  <!-- ACTIONS -->
  <div class="actions">
    <button class="btn" id="exportBtn" type="button">
      <i class="fa-solid fa-file-pdf" aria-hidden="true"></i>
      PDF
    </button>
  </div>

</div>

<!-- PROGRESS -->
<div class="progress-overlay" id="progressOverlay" aria-hidden="true">
  <div class="progress-box">
    <strong>Generating PDFâ€¦</strong>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
  </div>
</div>

<script>
const { jsPDF } = window.jspdf;

const menu = document.getElementById("menu");
const toolHeader = document.getElementById("toolHeader");

function toggleMenu() {
  menu.classList.toggle("show");
}
function closeMenu() {
  menu.classList.remove("show");
}

toolHeader.addEventListener("click", (e) => {
  // Allow link clicks to pass through
  if (e.target.closest("a")) return;
  toggleMenu();
});
toolHeader.addEventListener("keydown", (e) => {
  if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggleMenu(); }
});

document.addEventListener("click", (e) => {
  if (!e.target.closest(".header")) closeMenu();
});
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeMenu();
});

const frontDrop = document.getElementById("frontDrop");
const backDrop  = document.getElementById("backDrop");
const frontInput = document.getElementById("frontInput");
const backInput  = document.getElementById("backInput");

const paperEl = document.getElementById("paper");
const qtyEl = document.getElementById("quantity");
const layoutEl = document.getElementById("layout");
const orientEl = document.getElementById("orientation");
const exportBtn = document.getElementById("exportBtn");

const progressOverlay = document.getElementById("progressOverlay");
const progressFill = document.getElementById("progressFill");

let images = [];      // array of dataURL strings
let backing = null;   // dataURL string or null

function fileToDataURL(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

frontDrop.addEventListener("click", () => frontInput.click());
backDrop.addEventListener("click", () => backInput.click());

frontDrop.addEventListener("dragover", (e) => e.preventDefault());
backDrop.addEventListener("dragover", (e) => e.preventDefault());

frontDrop.addEventListener("drop", async (e) => {
  e.preventDefault();
  await addFrontFiles(e.dataTransfer.files);
});
backDrop.addEventListener("drop", async (e) => {
  e.preventDefault();
  const f = [...e.dataTransfer.files].find(x => x.type.startsWith("image/"));
  if (!f) return;
  backing = await fileToDataURL(f);
  backDrop.querySelector("strong").textContent = "Backing loaded";
  backDrop.querySelector("small").textContent = "click to replace";
});

frontInput.addEventListener("change", async (e) => addFrontFiles(e.target.files));
backInput.addEventListener("change", async (e) => {
  const f = [...e.target.files].find(x => x.type.startsWith("image/"));
  if (!f) return;
  backing = await fileToDataURL(f);
  backDrop.querySelector("strong").textContent = "Backing loaded";
  backDrop.querySelector("small").textContent = "click to replace";
});

async function addFrontFiles(fileList) {
  const files = [...fileList].filter(f => f.type.startsWith("image/"));
  if (!files.length) return;

  const urls = await Promise.all(files.map(fileToDataURL));
  images.push(...urls);

  frontDrop.querySelector("strong").textContent = `${images.length} image(s) loaded`;
  frontDrop.querySelector("small").textContent = "click to add more";
}

function computeGrid(n) {
  const cols = Math.ceil(Math.sqrt(n));
  const rows = Math.ceil(n / cols);
  return { cols, rows };
}

function setPageVars() {
  const paper = paperEl.value.toUpperCase();
  const ori = orientEl.value;
  document.documentElement.style.setProperty("--page-size", `${paper} ${ori}`);
  document.documentElement.style.setProperty("--page-margin", layoutEl.value === "fill" ? "0mm" : "15mm");
}

async function exportPDF() {
  if (!images.length) {
    alert("Add images first.");
    return;
  }

  setPageVars();

  const perPage = Number(qtyEl.value);
  const { cols, rows } = computeGrid(perPage);

  const pdf = new jsPDF({
    unit: "mm",
    format: paperEl.value,
    orientation: orientEl.value
  });

  const w = pdf.internal.pageSize.getWidth();
  const h = pdf.internal.pageSize.getHeight();

  progressOverlay.style.display = "flex";
  progressFill.style.width = "0%";

  const totalPages = (() => {
    const frontPages = Math.ceil(images.length / perPage);
    return backing ? frontPages * 2 : frontPages;
  })();

  let written = 0;

  for (let i = 0; i < images.length; i += perPage) {
    // FRONT PAGE
    const page = document.createElement("div");
    page.style.width = w + "mm";
    page.style.height = h + "mm";
    page.style.display = "grid";
    page.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
    page.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
    page.style.gap = (layoutEl.value === "fill") ? "0" : "10mm";
    page.style.background = "#fff";

    const slice = images.slice(i, i + perPage);
    slice.forEach(src => {
      const img = document.createElement("img");
      img.src = src;
      img.style.width = "100%";
      img.style.height = "100%";
      img.style.objectFit = "cover";
      page.appendChild(img);
    });

    const canvas = await html2canvas(page, { scale: 2, backgroundColor: "#ffffff" });

    if (written > 0) pdf.addPage();
    pdf.addImage(canvas.toDataURL("image/jpeg", 0.98), "JPEG", 0, 0, w, h);

    written++;
    progressFill.style.width = `${Math.round((written / totalPages) * 100)}%`;

    // BACKING PAGE
    if (backing) {
      pdf.addPage();
      pdf.addImage(backing, "JPEG", 0, 0, w, h);
      written++;
      progressFill.style.width = `${Math.round((written / totalPages) * 100)}%`;
    }
  }

  progressOverlay.style.display = "none";
  window.open(pdf.output("bloburl"), "_blank");
}

exportBtn.addEventListener("click", exportPDF);
</script>

</body>
</html>
