<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Playing Cards</title>

<link rel="icon" type="image/svg+xml" href="logo.svg" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
*, *::before, *::after { box-sizing: border-box; }
@page { size: var(--page-size); margin:0; }

:root{
  --accent:#2b6cb0;
  --bg:#f4f6f8;
  --border:#e0e0e0;
  --shadow:0 10px 22px rgba(0,0,0,.1);
  --shadow-hover:0 12px 26px rgba(0,0,0,.16);
  --page-size: A4 landscape;
}

body{
  margin:0;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background: var(--bg);
  color:#111;
}

.main{
  max-width: 760px;
  margin: 80px auto;
  background:#fff;
  padding: 28px;
  border-radius: 14px;
  box-shadow: var(--shadow);
}

/* HEADER + MENU */
.header{
  position: relative;
  display:flex;
  align-items:center;
  gap:10px;
  cursor:pointer;
  user-select:none;
}
.header img{ width:36px; height:36px; }
.header h1{ margin:0; font-size:22px; font-weight:650; }
.header .chev{ margin-left:auto; color:#666; }

.menu{
  position:absolute;
  top:52px;
  left:0;
  min-width: 230px;
  background:#fff;
  border:1px solid var(--border);
  border-radius: 10px;
  box-shadow: var(--shadow);
  display:none;
  flex-direction:column;
  z-index:50;
  overflow:hidden;
}
.menu.show{ display:flex; }
.menu a{
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px 14px;
  color:#111;
  text-decoration:none;
  font-size:15px;
}
.menu a:hover{ background:#f1f3f5; }
.menu a i{ width:18px; text-align:center; color:#333; }

/* DROP ZONES */
.drop{
  width:100%;
  border:2px dashed var(--border);
  border-radius: 12px;
  padding: 28px 18px;
  text-align:center;
  cursor:pointer;
  margin: 18px 0;
  transition: border-color .2s ease, box-shadow .2s ease, transform .2s ease;
  background:#fff;
}
.drop .icon{ font-size: 30px; color: var(--accent); margin-bottom:8px; }
.drop:hover{
  border-color: var(--accent);
  box-shadow: 0 0 0 4px rgba(43,108,176,.12);
  transform: translateY(-2px);
}
.drop small{ display:block; color:#555; margin-top:6px; }

/* CONTROLS */
.controls{
  display:grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-top: 8px;
}
.controls label{
  font-size:13px;
  color:#444;
  margin-bottom:6px;
  display:block;
}
.controls select{
  width:100%;
  padding:10px 12px;
  border-radius: 10px;
  border:1px solid var(--border);
}

/* ACTION BUTTON */
.actions{
  margin-top: 22px;
}
.btn{
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding: 10px 14px;
  border-radius: 10px;
  border:none;
  background: var(--accent);
  color:#fff;
  cursor:pointer;
  width:auto;
  transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
  font-size: 15px;
}
.btn:hover{
  transform: translateY(-2px) scale(.98);
  box-shadow: var(--shadow-hover);
  filter: brightness(1.02);
}
.btn:active{
  transform: translateY(-1px) scale(.99);
  box-shadow: var(--shadow);
}

/* PREVIEW PAGES */
#pages{
  display:flex;
  flex-direction:column;
  gap: 26px;
  margin-top: 26px;
}

.page{
  background:#fff;
  display:grid;
  box-shadow: var(--shadow);
}

/* landscape only */
.page.a4{ width:297mm; height:210mm; }
.page.a3{ width:420mm; height:297mm; }

/* cells */
.cell{
  position:relative;
  overflow:hidden;
  border:1px solid var(--border);
}

.cell img{
  width:100%;
  height:100%;
  object-fit:cover;
}

/* tools */
.tools{
  position:absolute;
  top:6px;
  right:6px;
  display:flex;
  gap:6px;
  opacity:0;
  pointer-events:none;
  transition:opacity .15s ease;
}
.cell:hover .tools{
  opacity:1;
  pointer-events:auto;
}
.tools button{
  width:28px;
  height:28px;
  border-radius:999px;
  border:none;
  background:rgba(0,0,0,.65);
  color:#fff;
  cursor:pointer;
}
.exporting .tools{ display:none !important; }

/* progress */
.progress-overlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.progress-box{
  width:340px;
  background:#fff;
  border:1px solid var(--border);
  border-radius:12px;
  box-shadow:var(--shadow);
  padding:18px;
}
.progress-box strong{ display:block; margin-bottom:10px; }
.progress-bar{
  height:10px;
  background:#eee;
  border-radius:999px;
  overflow:hidden;
}
.progress-fill{
  height:100%;
  width:0%;
  background:var(--accent);
  transition:width .25s ease;
}
</style>
</head>

<body>

<div class="main">

  <!-- HEADER -->
  <div class="header" id="toolHeader" tabindex="0">
    <img src="logo.svg" alt="logo" />
    <h1>Playing Cards</h1>
    <i class="fa-solid fa-chevron-down chev"></i>

    <nav class="menu" id="menu">
      <a href="image2sheet.html"><i class="fa-solid fa-layer-group"></i>Image2Sheet</a>
      <a href="image2scale.html"><i class="fa-solid fa-up-right-and-down-left-from-center"></i>Image2Scale</a>
      <a href="cards.html"><i class="fa-solid fa-clone"></i>Playing cards</a>
    </nav>
  </div>

  <!-- FRONT DROP -->
  <div class="drop" id="dropZone">
    <div class="icon"><i class="fa-solid fa-cloud-arrow-up"></i></div>
    <strong>Drop card images here</strong>
    <small>or click to choose files</small>
    <input type="file" id="fileInput" hidden multiple accept="image/*" />
  </div>

  <!-- BACK DROP (SECOND INPUT, OPTIONAL) -->
  <div class="drop" id="backDrop">
    <div class="icon"><i class="fa-regular fa-image"></i></div>
    <strong>Optional backing image</strong>
    <small>added as every second page</small>
    <input type="file" id="backInput" hidden accept="image/*" />
  </div>

  <div class="controls">
    <div>
      <label for="paperSize">Paper size</label>
      <select id="paperSize">
        <option value="a4" selected>A4 (Landscape)</option>
        <option value="a3">A3 (Landscape)</option>
      </select>
    </div>
  </div>

  <div class="actions">
    <button class="btn" id="exportBtn" type="button">
      <i class="fa-solid fa-file-pdf"></i> PDF
    </button>
  </div>

  <!-- PREVIEW -->
  <div id="pages"></div>

</div>

<!-- PROGRESS -->
<div class="progress-overlay" id="progressOverlay">
  <div class="progress-box">
    <strong>Generating PDFâ€¦</strong>
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  </div>
</div>

<script>
const { jsPDF } = window.jspdf;

const menu = document.getElementById("menu");
const toolHeader = document.getElementById("toolHeader");
function toggleMenu(){ menu.classList.toggle("show"); }
function closeMenu(){ menu.classList.remove("show"); }

toolHeader.addEventListener("click", (e) => {
  if (e.target.closest("a")) return;
  toggleMenu();
});
toolHeader.addEventListener("keydown", (e) => {
  if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggleMenu(); }
});
document.addEventListener("click", (e) => {
  if (!e.target.closest(".header")) closeMenu();
});
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeMenu();
});

const pagesEl = document.getElementById("pages");
const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("fileInput");
const backDrop = document.getElementById("backDrop");
const backInput = document.getElementById("backInput");
const paperSize = document.getElementById("paperSize");
const exportBtn = document.getElementById("exportBtn");

const progressOverlay = document.getElementById("progressOverlay");
const progressFill = document.getElementById("progressFill");

const CARD = { width:63, height:88 }; // mm
const PAGE = {
  a4:{ width:297, height:210 }, // landscape
  a3:{ width:420, height:297 }  // landscape
};

let images = [];      // dataURL strings
let backingImage = null; // dataURL string or null
let dragIndex = null;

function fileToDataURL(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

/* Inputs */
dropZone.addEventListener("click", () => fileInput.click());
fileInput.addEventListener("change", async (e) => addImages(e.target.files));

dropZone.addEventListener("dragover", (e) => e.preventDefault());
dropZone.addEventListener("drop", async (e) => {
  e.preventDefault();
  await addImages(e.dataTransfer.files);
});

backDrop.addEventListener("click", () => backInput.click());
backDrop.addEventListener("dragover", (e) => e.preventDefault());
backDrop.addEventListener("drop", async (e) => {
  e.preventDefault();
  const f = [...e.dataTransfer.files].find(x => x.type.startsWith("image/"));
  if (!f) return;
  backingImage = await fileToDataURL(f);
  backDrop.querySelector("strong").textContent = "Backing loaded";
  backDrop.querySelector("small").textContent = "click to replace";
  render();
});
backInput.addEventListener("change", async (e) => {
  const f = [...e.target.files].find(x => x.type.startsWith("image/"));
  if (!f) return;
  backingImage = await fileToDataURL(f);
  backDrop.querySelector("strong").textContent = "Backing loaded";
  backDrop.querySelector("small").textContent = "click to replace";
  render();
});

paperSize.addEventListener("change", render);

async function addImages(files) {
  const imgs = [...files].filter(f => f.type.startsWith("image/"));
  if (!imgs.length) return;

  const urls = await Promise.all(imgs.map(fileToDataURL));
  images.push(...urls);

  dropZone.querySelector("strong").textContent = `${images.length} image(s) loaded`;
  dropZone.querySelector("small").textContent = "click to add more";
  render();
}

/* Auto-fit grid */
function grid() {
  const page = PAGE[paperSize.value];
  const cols = Math.floor(page.width / CARD.width);
  const rows = Math.floor(page.height / CARD.height);
  return { cols, rows, per: cols * rows };
}

/* Render preview pages */
function render() {
  pagesEl.innerHTML = "";
  document.documentElement.style.setProperty("--page-size", paperSize.value.toUpperCase() + " landscape");

  const g = grid();

  for (let i = 0; i < images.length; i += g.per) {
    renderPage(images.slice(i, i + g.per), i, g.cols, g.rows, false);
    if (backingImage) renderPage(Array(g.per).fill(backingImage), 0, g.cols, g.rows, true);
  }
}

function renderPage(srcs, base, cols, rows, backing) {
  const page = document.createElement("div");
  page.className = `page ${paperSize.value}`;
  page.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  page.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

  srcs.forEach((src, idx) => {
    const i = base + idx;
    const cell = document.createElement("div");
    cell.className = "cell";
    cell.draggable = !backing;

    const img = document.createElement("img");
    img.src = src;
    cell.appendChild(img);

    if (!backing) {
      const tools = document.createElement("div");
      tools.className = "tools";
      tools.innerHTML = `
        <button type="button" title="Copy" onclick="copyImg(${i})"><i class="fa-solid fa-copy"></i></button>
        <button type="button" title="Delete" onclick="deleteImg(${i})"><i class="fa-solid fa-trash"></i></button>
      `;
      cell.appendChild(tools);

      cell.ondragstart = () => dragIndex = i;
      cell.ondragover = (e) => e.preventDefault();
      cell.ondrop = () => {
        const moved = images.splice(dragIndex, 1)[0];
        images.splice(i, 0, moved);
        render();
      };
    }

    page.appendChild(cell);
  });

  pagesEl.appendChild(page);
}

window.copyImg = function(i){
  images.splice(i + 1, 0, images[i]);
  render();
};
window.deleteImg = function(i){
  images.splice(i, 1);
  render();
};

/* PDF Export */
async function exportPDF() {
  const pages = document.querySelectorAll(".page");
  if (!pages.length) {
    alert("Add images first.");
    return;
  }

  progressOverlay.style.display = "flex";
  progressFill.style.width = "0%";
  document.body.classList.add("exporting");

  const pdf = new jsPDF({
    orientation: "landscape",
    unit: "mm",
    format: paperSize.value
  });

  for (let i = 0; i < pages.length; i++) {
    const canvas = await html2canvas(pages[i], { scale: 2, backgroundColor: "#ffffff" });
    if (i > 0) pdf.addPage();

    pdf.addImage(
      canvas.toDataURL("image/jpeg", 0.98),
      "JPEG",
      0, 0,
      pdf.internal.pageSize.getWidth(),
      pdf.internal.pageSize.getHeight()
    );

    progressFill.style.width = `${Math.round(((i + 1) / pages.length) * 100)}%`;
  }

  progressOverlay.style.display = "none";
  document.body.classList.remove("exporting");
  window.open(pdf.output("bloburl"), "_blank");
}

exportBtn.addEventListener("click", exportPDF);
</script>

</body>
</html>
