<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Playing Cards</title>

<link rel="icon" type="image/svg+xml" href="logo.svg" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
*, *::before, *::after { box-sizing:border-box; }
@page { size: var(--page-size); margin:0; }

:root{
  --accent:#2b6cb0;
  --bg:#f4f6f8;
  --border:#e0e0e0;
  --shadow:0 10px 22px rgba(0,0,0,.1);
  --shadow-hover:0 12px 26px rgba(0,0,0,.16);
}

body{
  margin:0;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:var(--bg);
}

/* ---------- UI CONTAINER ---------- */
.main{
  max-width:1000px;
  margin:80px auto 30px;
  background:#fff;
  padding:28px;
  border-radius:14px;
  box-shadow:var(--shadow);
}

/* ---------- HEADER ---------- */
.header{
  position:relative;
  display:flex;
  align-items:center;
  gap:10px;
  cursor:pointer;
}
.header img{ width:36px;height:36px; }
.header h1{ margin:0;font-size:22px;font-weight:650; }
.header .chev{ margin-left:auto;color:#666; }

.menu{
  position:absolute;
  top:52px;
  left:0;
  min-width:230px;
  background:#fff;
  border:1px solid var(--border);
  border-radius:10px;
  box-shadow:var(--shadow);
  display:none;
  flex-direction:column;
  z-index:50;
}
.menu.show{ display:flex; }
.menu a{
  padding:12px 14px;
  display:flex;
  gap:10px;
  text-decoration:none;
  color:#111;
}
.menu a:hover{ background:#f1f3f5; }

/* ---------- DROP ZONES ---------- */
.drop{
  width:100%;
  border:2px dashed var(--border);
  border-radius:12px;
  padding:28px 18px;
  text-align:center;
  cursor:pointer;
  margin:18px 0;
  transition:border-color .2s, box-shadow .2s, transform .2s;
}
.drop:hover{
  border-color:var(--accent);
  box-shadow:0 0 0 4px rgba(43,108,176,.12);
  transform:translateY(-2px);
}
.drop .icon{
  font-size:30px;
  color:var(--accent);
  margin-bottom:6px;
}

/* ---------- CONTROLS ---------- */
.controls label{
  display:block;
  font-size:13px;
  color:#444;
  margin-bottom:6px;
}
.controls select{
  width:100%;
  max-width:260px;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:15px;
}

/* ---------- ACTION ---------- */
.actions{
  margin-top:22px;
}
.btn{
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding:10px 14px;
  border-radius:10px;
  border:none;
  background:var(--accent);
  color:#fff;
  cursor:pointer;
  transition:transform .15s, box-shadow .15s;
}
.btn:hover{
  transform:translateY(-2px) scale(.98);
  box-shadow:var(--shadow-hover);
}

/* ---------- PAPER AREA ---------- */
.paper-wrap{
  width:100%;
  padding:40px 0 80px;
}

#pages{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:50px;
}

/* ---------- PAGES ---------- */
.page{
  background:#fff;
  display:grid;
  box-shadow:
    0 0 0 1px #ddd,
    0 16px 36px rgba(0,0,0,.18);
}

.page.a4{ width:297mm;height:210mm; }
.page.a3{ width:420mm;height:297mm; }

/* ---------- CELLS ---------- */
.cell{
  position:relative;
  border:1px solid var(--border);
  overflow:hidden;
}
.cell img{
  width:100%;
  height:100%;
  object-fit:cover;
}

/* ---------- TOOLS ---------- */
.tools{
  position:absolute;
  top:6px;
  right:6px;
  display:flex;
  gap:6px;
  opacity:0;
}
.cell:hover .tools{ opacity:1; }
.tools button{
  width:28px;
  height:28px;
  border-radius:50%;
  border:none;
  background:rgba(0,0,0,.65);
  color:#fff;
  cursor:pointer;
}
.exporting .tools{ display:none!important; }

/* ---------- PROGRESS ---------- */
.progress-overlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.progress-box{
  width:320px;
  background:#fff;
  border-radius:12px;
  padding:18px;
  box-shadow:var(--shadow);
}
.progress-bar{
  height:8px;
  background:#eee;
  border-radius:999px;
  overflow:hidden;
}
.progress-fill{
  height:100%;
  width:0%;
  background:var(--accent);
  transition:width .25s;
}
</style>
</head>

<body>

<div class="main">

  <!-- HEADER -->
  <div class="header" id="toolHeader">
    <img src="logo.svg">
    <h1>Playing Cards</h1>
    <i class="fa-solid fa-chevron-down chev"></i>

    <nav class="menu" id="menu">
      <a href="index.html"><i class="fa-solid fa-layer-group"></i>Image2Sheet</a>
      <a href="image2scale.html"><i class="fa-solid fa-up-right-and-down-left-from-center"></i>Image2Scale</a>
      <a href="image2direct.html"><i class="fa-solid fa-shirt"></i>Image2Direct</a>
      <a href="cards.html"><i class="fa-solid fa-clone"></i>Playing Cards</a>
    </nav>
  </div>

  <!-- FRONT DROP -->
  <div class="drop" id="dropZone">
    <div class="icon"><i class="fa-solid fa-cloud-arrow-up"></i></div>
    <strong>Drop card images here</strong>
    <div>or click to choose files</div>
    <input type="file" id="fileInput" hidden multiple accept="image/*">
  </div>

  <!-- BACKING DROP -->
  <div class="drop" id="backDrop">
    <div class="icon"><i class="fa-regular fa-image"></i></div>
    <strong>Optional backing image</strong>
    <div>added as every second page</div>
    <input type="file" id="backingInput" hidden accept="image/*">
  </div>

  <div class="controls">
    <label>Paper size</label>
    <select id="paperSize">
      <option value="a4">A4 (Landscape)</option>
      <option value="a3">A3 (Landscape)</option>
    </select>
  </div>

  <div class="actions">
    <button class="btn" id="exportBtn">
      <i class="fa-solid fa-file-pdf"></i> PDF
    </button>
  </div>

</div>

<!-- PAPER PREVIEW (OUTSIDE CONTAINER) -->
<div class="paper-wrap">
  <div id="pages"></div>
</div>

<!-- PROGRESS -->
<div class="progress-overlay" id="progressOverlay">
  <div class="progress-box">
    <strong>Generating PDFâ€¦</strong>
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  </div>
</div>

<script>
const { jsPDF } = window.jspdf;

const pagesEl = document.getElementById("pages");
const dropZone = document.getElementById("dropZone");
const backDrop = document.getElementById("backDrop");
const fileInput = document.getElementById("fileInput");
const backingInput = document.getElementById("backingInput");
const paperSize = document.getElementById("paperSize");
const exportBtn = document.getElementById("exportBtn");

const progressOverlay = document.getElementById("progressOverlay");
const progressFill = document.getElementById("progressFill");

const CARD = { width:63, height:88 };
const PAGE = {
  a4:{ width:297, height:210 },
  a3:{ width:420, height:297 }
};

let images = [];
let backingImage = null;
let dragIndex = null;

/* INPUTS */
dropZone.onclick = () => fileInput.click();
fileInput.onchange = e => addImages(e.target.files);
dropZone.ondragover = e => e.preventDefault();
dropZone.ondrop = e => { e.preventDefault(); addImages(e.dataTransfer.files); };

backDrop.onclick = () => backingInput.click();
backDrop.ondragover = e => e.preventDefault();
backDrop.ondrop = e => handleBacking(e.dataTransfer.files);
backingInput.onchange = e => handleBacking(e.target.files);

paperSize.onchange = render;

/* FUNCTIONS */
function handleBacking(files){
  const f=[...files].find(x=>x.type.startsWith("image/"));
  if(!f)return;
  backingImage = URL.createObjectURL(f);
  render();
}

function addImages(files){
  [...files].forEach(f=>f.type.startsWith("image/") && images.push(URL.createObjectURL(f)));
  render();
}

function grid(){
  const p=PAGE[paperSize.value];
  const cols=Math.floor(p.width/CARD.width);
  const rows=Math.floor(p.height/CARD.height);
  return{cols,rows,per:cols*rows};
}

function render(){
  pagesEl.innerHTML="";
  document.documentElement.style.setProperty("--page-size",paperSize.value.toUpperCase()+" landscape");

  const g=grid();

  for(let i=0;i<images.length;i+=g.per){
    renderPage(images.slice(i,i+g.per),i,false);
    if(backingImage)renderPage(Array(g.per).fill(backingImage),0,true);
  }
}

function renderPage(srcs,base,backing){
  const page=document.createElement("div");
  page.className=`page ${paperSize.value}`;
  const g=grid();
  page.style.gridTemplateColumns=`repeat(${g.cols},1fr)`;
  page.style.gridTemplateRows=`repeat(${g.rows},1fr)`;

  srcs.forEach((src,idx)=>{
    const i=base+idx;
    const cell=document.createElement("div");
    cell.className="cell";
    cell.draggable=!backing;

    const img=document.createElement("img");
    img.src=src;
    cell.appendChild(img);

    if(!backing){
      const tools=document.createElement("div");
      tools.className="tools";
      tools.innerHTML=`
        <button onclick="copyImg(${i})"><i class="fa-solid fa-copy"></i></button>
        <button onclick="deleteImg(${i})"><i class="fa-solid fa-trash"></i></button>
      `;
      cell.appendChild(tools);

      cell.ondragstart=()=>dragIndex=i;
      cell.ondragover=e=>e.preventDefault();
      cell.ondrop=()=>{
        const moved=images.splice(dragIndex,1)[0];
        images.splice(i,0,moved);
        render();
      };
    }

    page.appendChild(cell);
  });

  pagesEl.appendChild(page);
}

window.copyImg=i=>{ images.splice(i+1,0,images[i]); render(); };
window.deleteImg=i=>{ images.splice(i,1); render(); };

function waitForImage(img){
  if(img.complete && img.naturalWidth) return Promise.resolve();
  return new Promise(resolve=>{
    img.addEventListener("load",resolve,{once:true});
    img.addEventListener("error",resolve,{once:true});
  });
}

const TRIM_COLOR_THRESHOLD=245;
const TRIM_COLOR_DISTANCE=18;

function colorDistance(a,b){
  const dr=a.r-b.r;
  const dg=a.g-b.g;
  const db=a.b-b.b;
  return Math.sqrt(dr*dr+dg*dg+db*db);
}

function averageColor(colors){
  const total=colors.reduce((acc,c)=>({r:acc.r+c.r,g:acc.g+c.g,b:acc.b+c.b}),{r:0,g:0,b:0});
  return {
    r:Math.round(total.r/colors.length),
    g:Math.round(total.g/colors.length),
    b:Math.round(total.b/colors.length)
  };
}

function edgeBackgroundColor(data,width,height){
  const corners=[
    {x:0,y:0},
    {x:width-1,y:0},
    {x:0,y:height-1},
    {x:width-1,y:height-1}
  ];
  const colors=[];
  for(const {x,y} of corners){
    const idx=(y*width+x)*4;
    const a=data[idx+3];
    if(a===0)continue;
    colors.push({r:data[idx],g:data[idx+1],b:data[idx+2]});
  }
  if(!colors.length)return null;
  const avg=averageColor(colors);
  const maxDistance=Math.max(...colors.map(c=>colorDistance(c,avg)));
  if(maxDistance>TRIM_COLOR_DISTANCE*2)return null;
  return avg;
}

function isTrimPixel(r,g,b,a,background){
  if(a===0)return true;
  if(background){
    return colorDistance({r,g,b},background)<=TRIM_COLOR_DISTANCE;
  }
  return r>=TRIM_COLOR_THRESHOLD && g>=TRIM_COLOR_THRESHOLD && b>=TRIM_COLOR_THRESHOLD;
}

function trimWhitespaceEdges(img){
  const canvas=document.createElement("canvas");
  const ctx=canvas.getContext("2d");
  canvas.width=img.naturalWidth;
  canvas.height=img.naturalHeight;
  ctx.drawImage(img,0,0);
  const {data,width,height}=ctx.getImageData(0,0,canvas.width,canvas.height);
  const background=edgeBackgroundColor(data,width,height);
  let top=height,right=0,bottom=0,left=width;

  for(let y=0;y<height;y++){
    for(let x=0;x<width;x++){
      const idx=(y*width+x)*4;
      if(!isTrimPixel(data[idx],data[idx+1],data[idx+2],data[idx+3],background)){
        if(x<left)left=x;
        if(x>right)right=x;
        if(y<top)top=y;
        if(y>bottom)bottom=y;
      }
    }
  }

  if(right<left||bottom<top)return img.src;
  const trimWidth=right-left+1;
  const trimHeight=bottom-top+1;
  if(trimWidth===width&&trimHeight===height)return img.src;

  const trimmed=document.createElement("canvas");
  trimmed.width=trimWidth;
  trimmed.height=trimHeight;
  trimmed
    .getContext("2d")
    .drawImage(canvas,left,top,trimWidth,trimHeight,0,0,trimWidth,trimHeight);
  return trimmed.toDataURL("image/png");
}

function cropToCover(img,container){
  const targetWidth=container?.clientWidth ?? img.naturalWidth;
  const targetHeight=container?.clientHeight ?? img.naturalHeight;
  if(!targetWidth || !targetHeight)return img.src;

  const targetRatio=targetWidth/targetHeight;
  const srcRatio=img.naturalWidth/img.naturalHeight;
  let cropWidth=img.naturalWidth;
  let cropHeight=img.naturalHeight;
  let offsetX=0;
  let offsetY=0;

  if(srcRatio>targetRatio){
    cropWidth=Math.round(img.naturalHeight*targetRatio);
    offsetX=Math.round((img.naturalWidth-cropWidth)/2);
  }else{
    cropHeight=Math.round(img.naturalWidth/targetRatio);
    offsetY=Math.round((img.naturalHeight-cropHeight)/2);
  }

  const canvas=document.createElement("canvas");
  canvas.width=cropWidth;
  canvas.height=cropHeight;
  canvas
    .getContext("2d")
    .drawImage(img,offsetX,offsetY,cropWidth,cropHeight,0,0,cropWidth,cropHeight);
  return canvas.toDataURL("image/png");
}

async function buildExportImage(img){
  const trimmedSrc=trimWhitespaceEdges(img);
  const tempImg=new Image();
  tempImg.src=trimmedSrc;
  await waitForImage(tempImg);
  if(!tempImg.naturalWidth)return trimmedSrc;
  const container=img.closest(".cell");
  return cropToCover(tempImg,container);
}

async function prepareImagesForExport(){
  const imgEls=[...document.querySelectorAll(".page img")];
  const originals=new Map();

  for(const img of imgEls){
    originals.set(img,img.src);
    await waitForImage(img);
    if(!img.naturalWidth)continue;
    const exportSrc=await buildExportImage(img);
    if(exportSrc!==img.src){
      img.src=exportSrc;
      await waitForImage(img);
    }
  }

  return ()=>originals.forEach((src,img)=>{ img.src=src; });
}

/* EXPORT */
exportBtn.onclick = async () => {
  const pages=document.querySelectorAll(".page");
  if(!pages.length)return;

  progressOverlay.style.display="flex";
  progressFill.style.width="0%";
  document.body.classList.add("exporting");

  const restoreImages=await prepareImagesForExport();

  try{
    const pdf=new jsPDF({
      orientation:"landscape",
      unit:"mm",
      format:paperSize.value
    });

    for(let i=0;i<pages.length;i++){
      const canvas=await html2canvas(pages[i],{scale:2,backgroundColor:"#fff"});
      if(i>0)pdf.addPage();
      pdf.addImage(
        canvas.toDataURL("image/jpeg",0.98),
        "JPEG",
        0,0,
        pdf.internal.pageSize.getWidth(),
        pdf.internal.pageSize.getHeight()
      );
      progressFill.style.width=`${Math.round(((i+1)/pages.length)*100)}%`;
    }

    window.open(pdf.output("bloburl"),"_blank");
  }finally{
    restoreImages();
    progressOverlay.style.display="none";
    document.body.classList.remove("exporting");
  }
};

/* MENU */
const menu=document.getElementById("menu");
document.getElementById("toolHeader").onclick=e=>{
  if(!e.target.closest("a"))menu.classList.toggle("show");
};
document.onclick=e=>{
  if(!e.target.closest(".header"))menu.classList.remove("show");
};
</script>

</body>
</html>

